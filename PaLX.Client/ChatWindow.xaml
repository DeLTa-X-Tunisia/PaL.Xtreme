<Window x:Class="PaLX.Client.ChatWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:System="clr-namespace:System;assembly=mscorlib"
        xmlns:converters="clr-namespace:PaLX.Client.Converters"
        xmlns:models="clr-namespace:PaLX.Client.Models"
        xmlns:controls="clr-namespace:PaLX.Client.Controls"
        mc:Ignorable="d"
        Title="Chat" Height="700" Width="800"
        WindowStyle="None" AllowsTransparency="True" Background="Transparent"
        ResizeMode="CanResizeWithGrip"
        MinHeight="500" MinWidth="500"
        WindowStartupLocation="CenterScreen">

    <Window.Resources>
        <!-- Use App-level colors where possible -->
        <SolidColorBrush x:Key="PrimaryColor" Color="#E03E2F"/>
        <SolidColorBrush x:Key="AccentColor" Color="#FF6B5B"/>
        <SolidColorBrush x:Key="LightGrayColor" Color="#F8F9FA"/>
        <SolidColorBrush x:Key="BorderColor" Color="#E8E8E8"/>
        <SolidColorBrush x:Key="TextDarkColor" Color="#1A1A2E"/>
        <SolidColorBrush x:Key="TextLightColor" Color="#6B7280"/>

        <!-- Styles -->
        <Style x:Key="IconButtonStyle" TargetType="Button">
            <Setter Property="FontFamily" Value="Segoe MDL2 Assets"/>
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="40"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Foreground" Value="{StaticResource TextDarkColor}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="12">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#F0F0F0"/>
                </Trigger>
                <Trigger Property="IsPressed" Value="True">
                    <Setter Property="Background" Value="#E8E8E8"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="SendButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryColor}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="48"/>
            <Setter Property="Height" Value="48"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="16">
                            <Border.Effect>
                                <DropShadowEffect Color="#E03E2F" BlurRadius="12" ShadowDepth="0" Opacity="0.3"/>
                            </Border.Effect>
                            <TextBlock Text="&#xE724;" FontFamily="Segoe MDL2 Assets" FontSize="18" 
                                       HorizontalAlignment="Center" VerticalAlignment="Center" Margin="2,0,0,0"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource AccentColor}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#C93529"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <!-- Window Control Button -->
        <Style x:Key="WindowControlButton" TargetType="Button">
            <Setter Property="Width" Value="40"/>
            <Setter Property="Height" Value="32"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="0">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#10000000"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="CloseWindowButton" TargetType="Button" BasedOn="{StaticResource WindowControlButton}">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="0,16,0,0">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#E81123"/>
                                <Setter Property="Foreground" Value="White"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <Style x:Key="AttachmentMenuItemStyle" TargetType="MenuItem">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="Foreground" Value="{StaticResource TextDarkColor}"/>
            <Setter Property="Icon">
                <Setter.Value>
                    <TextBlock FontFamily="Segoe MDL2 Assets" FontSize="16" VerticalAlignment="Center"/>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <!-- Main Container with Shadow -->
    <Border CornerRadius="20" Margin="10">
        <Border.Background>
            <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                <GradientStop Color="#FFFFFF" Offset="0"/>
                <GradientStop Color="#FAFAFA" Offset="1"/>
            </LinearGradientBrush>
        </Border.Background>
        <Border.Effect>
            <DropShadowEffect BlurRadius="30" ShadowDepth="0" Opacity="0.15" Color="Black"/>
        </Border.Effect>
        
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/> <!-- Header -->
                <RowDefinition Height="*"/>    <!-- Chat Body -->
                <RowDefinition Height="Auto"/> <!-- Input Area -->
            </Grid.RowDefinitions>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- HEADER                                                           -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <Border Grid.Row="0" CornerRadius="20,20,0,0" Padding="20,12" MouseLeftButtonDown="Header_MouseDown">
                <Border.Background>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                        <GradientStop Color="#E03E2F" Offset="0"/>
                        <GradientStop Color="#8B2920" Offset="1"/>
                    </LinearGradientBrush>
                </Border.Background>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/> <!-- Avatar -->
                        <ColumnDefinition Width="*"/>    <!-- Info -->
                        <ColumnDefinition Width="Auto"/> <!-- Actions -->
                    </Grid.ColumnDefinitions>

                    <!-- Avatar -->
                    <Grid Grid.Column="0">
                        <Border Width="50" Height="50" CornerRadius="25" BorderBrush="White" BorderThickness="2">
                            <Border CornerRadius="23">
                                <Border.Background>
                                    <ImageBrush x:Name="AvatarBrush" ImageSource="/Assets/default_avatar.png" Stretch="UniformToFill"/>
                                </Border.Background>
                            </Border>
                        </Border>
                        <!-- Online Status Indicator -->
                        <Ellipse x:Name="StatusIndicator" Width="14" Height="14" Fill="#4CAF50" Stroke="White" StrokeThickness="2" 
                                 HorizontalAlignment="Right" VerticalAlignment="Bottom" Margin="0,0,2,2"/>
                    </Grid>

                    <!-- User Info -->
                    <StackPanel Grid.Column="1" Margin="16,0,0,0" VerticalAlignment="Center">
                        <TextBlock x:Name="PartnerName" Text="Utilisateur" FontWeight="Bold" FontSize="17" Foreground="White"/>
                        <TextBlock x:Name="PartnerStatus" Text="En ligne" FontSize="13" Foreground="#90FFFFFF"/>
                    </StackPanel>

                    <!-- Actions -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                        <!-- Audio Call -->
                        <Button Click="AudioCall_Click" ToolTip="Appel Audio" Width="40" Height="40" Background="#20FFFFFF" Margin="0,0,6,0" Cursor="Hand">
                            <Button.Template>
                                <ControlTemplate TargetType="Button">
                                    <Border x:Name="bg" Background="{TemplateBinding Background}" CornerRadius="12">
                                        <TextBlock Text="&#xE717;" FontFamily="Segoe MDL2 Assets" FontSize="16" Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="bg" Property="Background" Value="#40FFFFFF"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Button.Template>
                        </Button>
                        
                        <!-- Video Call -->
                        <Button ToolTip="Appel VidÃ©o" Width="40" Height="40" Background="#20FFFFFF" Margin="0,0,6,0" Cursor="Hand">
                            <Button.Template>
                                <ControlTemplate TargetType="Button">
                                    <Border x:Name="bg" Background="{TemplateBinding Background}" CornerRadius="12">
                                        <TextBlock Text="&#xE714;" FontFamily="Segoe MDL2 Assets" FontSize="16" Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="bg" Property="Background" Value="#40FFFFFF"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Button.Template>
                        </Button>
                        
                        <!-- Clear History -->
                        <Button Click="ClearHistory_Click" ToolTip="Effacer l'historique" Width="40" Height="40" Background="#20FFFFFF" Margin="0,0,6,0" Cursor="Hand">
                            <Button.Template>
                                <ControlTemplate TargetType="Button">
                                    <Border x:Name="bg" Background="{TemplateBinding Background}" CornerRadius="12">
                                        <TextBlock Text="&#xE74D;" FontFamily="Segoe MDL2 Assets" FontSize="15" Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="bg" Property="Background" Value="#40FFFFFF"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Button.Template>
                        </Button>

                        <!-- Block Button -->
                        <Button x:Name="BlockButton" Click="Block_Click" ToolTip="Bloquer cet utilisateur" Width="40" Height="40" Background="#20FFFFFF" Margin="0,0,12,0" Cursor="Hand">
                            <Button.Template>
                                <ControlTemplate TargetType="Button">
                                    <Border x:Name="bg" Background="{TemplateBinding Background}" CornerRadius="12">
                                        <Border Width="14" Height="14" CornerRadius="7" Background="{Binding Background, ElementName=BlockIndicator}" BorderBrush="White" BorderThickness="2"/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="bg" Property="Background" Value="#40FFFFFF"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Button.Template>
                        </Button>
                        <!-- Hidden BlockIndicator for code-behind reference -->
                        <Border x:Name="BlockIndicator" Background="#F44336" Width="0" Height="0" Visibility="Collapsed"/>

                        <Rectangle Width="1" Height="28" Fill="#40FFFFFF" Margin="0,0,12,0"/>

                        <!-- Window Controls -->
                        <Button Click="Minimize_Click" Style="{StaticResource WindowControlButton}" Width="36" Height="32">
                            <TextBlock Text="&#xE921;" FontFamily="Segoe MDL2 Assets" FontSize="10" Foreground="White"/>
                        </Button>
                        <Button Click="Close_Click" Width="36" Height="32" Cursor="Hand">
                            <Button.Template>
                                <ControlTemplate TargetType="Button">
                                    <Border x:Name="bg" Background="Transparent" CornerRadius="0,16,0,0">
                                        <TextBlock Text="&#xE8BB;" FontFamily="Segoe MDL2 Assets" FontSize="10" Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="bg" Property="Background" Value="#E81123"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Button.Template>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- CHAT BODY - WPF Native                                           -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <Border Grid.Row="1" Background="#F5F5F5">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/> <!-- Load More Button -->
                        <RowDefinition Height="*"/>    <!-- Messages -->
                    </Grid.RowDefinitions>
                    
                    <!-- Load More Messages Button -->
                    <Button x:Name="LoadMoreButton" Grid.Row="0" 
                            Content="Charger les messages prÃ©cÃ©dents"
                            HorizontalAlignment="Center"
                            Margin="0,10,0,5"
                            Padding="16,8"
                            Background="White"
                            BorderBrush="#E0E0E0"
                            BorderThickness="1"
                            Foreground="#666666"
                            FontSize="12"
                            Cursor="Hand"
                            Click="LoadMore_Click"
                            Visibility="Collapsed">
                        <Button.Template>
                            <ControlTemplate TargetType="Button">
                                <Border Background="{TemplateBinding Background}" 
                                        BorderBrush="{TemplateBinding BorderBrush}"
                                        BorderThickness="{TemplateBinding BorderThickness}"
                                        CornerRadius="15"
                                        Padding="{TemplateBinding Padding}">
                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="#F0F0F0"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Button.Template>
                    </Button>
                    
                    <!-- Messages List with Virtualization -->
                    <ListBox x:Name="MessagesListBox" Grid.Row="1"
                             Background="Transparent"
                             BorderThickness="0"
                             ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                             ScrollViewer.VerticalScrollBarVisibility="Auto"
                             VirtualizingPanel.IsVirtualizing="True"
                             VirtualizingPanel.VirtualizationMode="Recycling"
                             VirtualizingPanel.ScrollUnit="Pixel"
                             SelectionMode="Single"
                             HorizontalContentAlignment="Stretch">
                        <ListBox.Resources>
                            <!-- Import converters -->
                            <converters:IsMineToAlignmentConverter x:Key="IsMineToAlignmentConverter"/>
                            <converters:IsMineToBubbleColorConverter x:Key="IsMineToBubbleColorConverter"/>
                            <converters:IsMineToBorderConverter x:Key="IsMineToBorderConverter"/>
                            <converters:IsMineToCornerRadiusConverter x:Key="IsMineToCornerRadiusConverter"/>
                            <converters:IsMineToMarginConverter x:Key="IsMineToMarginConverter"/>
                            <converters:UrlToImageSourceConverter x:Key="UrlToImageSourceConverter"/>
                            <converters:TransferStatusToVisibilityConverter x:Key="TransferStatusToVisibilityConverter"/>
                            <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
                            <converters:ProgressToWidthConverter x:Key="ProgressToWidthConverter"/>
                            <converters:ShowActionsConverter x:Key="ShowActionsConverter"/>
                            <converters:AudioIconConverter x:Key="AudioIconConverter"/>
                            <converters:StatusToBackgroundConverter x:Key="StatusToBackgroundConverter"/>
                            <converters:StatusToForegroundConverter x:Key="StatusToForegroundConverter"/>
                            
                            <SolidColorBrush x:Key="PrimaryBrush" Color="#E03E2F"/>
                            <SolidColorBrush x:Key="AcceptBrush" Color="#4CAF50"/>
                            <SolidColorBrush x:Key="DeclineBrush" Color="#F44336"/>
                        </ListBox.Resources>
                        
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                <Setter Property="Padding" Value="0"/>
                                <Setter Property="Margin" Value="0"/>
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="ListBoxItem">
                                            <ContentPresenter/>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </ListBox.ItemContainerStyle>
                        
                        <ListBox.ItemTemplateSelector>
                            <converters:ChatMessageTemplateSelector>
                                <!-- Text Message Template -->
                                <converters:ChatMessageTemplateSelector.TextMessageTemplate>
                                    <DataTemplate DataType="{x:Type models:ChatMessageItem}">
                                        <Grid Margin="{Binding IsMine, Converter={StaticResource IsMineToMarginConverter}}"
                                              HorizontalAlignment="{Binding IsMine, Converter={StaticResource IsMineToAlignmentConverter}}">
                                            <Border Background="{Binding IsMine, Converter={StaticResource IsMineToBubbleColorConverter}}"
                                                    BorderBrush="{Binding IsMine, Converter={StaticResource IsMineToBorderConverter}}"
                                                    BorderThickness="1"
                                                    CornerRadius="{Binding IsMine, Converter={StaticResource IsMineToCornerRadiusConverter}}"
                                                    Padding="12,8"
                                                    MaxWidth="400">
                                                <StackPanel>
                                                    <TextBlock Text="{Binding SenderName}"
                                                               Visibility="{Binding IsMine, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=invert}"
                                                               FontSize="11"
                                                               FontWeight="SemiBold"
                                                               Foreground="{StaticResource PrimaryBrush}"
                                                               Margin="0,0,0,4"/>
                                                    <controls:RichMessageTextBlock RichContent="{Binding Content}"
                                                               TextWrapping="Wrap"
                                                               FontSize="14"
                                                               Foreground="#333333"/>
                                                    <TextBlock Text="{Binding Timestamp, StringFormat=HH:mm}"
                                                               HorizontalAlignment="Right"
                                                               FontSize="10"
                                                               Foreground="#888888"
                                                               Margin="0,4,0,0"/>
                                                </StackPanel>
                                            </Border>
                                        </Grid>
                                    </DataTemplate>
                                </converters:ChatMessageTemplateSelector.TextMessageTemplate>
                                
                                <!-- Image Message Template -->
                                <converters:ChatMessageTemplateSelector.ImageMessageTemplate>
                                    <DataTemplate DataType="{x:Type models:ChatMessageItem}">
                                        <Grid Margin="{Binding IsMine, Converter={StaticResource IsMineToMarginConverter}}"
                                              HorizontalAlignment="{Binding IsMine, Converter={StaticResource IsMineToAlignmentConverter}}">
                                            <Border Background="{Binding IsMine, Converter={StaticResource IsMineToBubbleColorConverter}}"
                                                    BorderBrush="{Binding IsMine, Converter={StaticResource IsMineToBorderConverter}}"
                                                    BorderThickness="1"
                                                    CornerRadius="{Binding IsMine, Converter={StaticResource IsMineToCornerRadiusConverter}}"
                                                    Padding="4">
                                                <StackPanel>
                                                    <TextBlock Text="{Binding SenderName}"
                                                               Visibility="{Binding IsMine, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=invert}"
                                                               FontSize="11"
                                                               FontWeight="SemiBold"
                                                               Foreground="{StaticResource PrimaryBrush}"
                                                               Margin="8,4,8,4"/>
                                                    <Border CornerRadius="8" ClipToBounds="True" Cursor="Hand" 
                                                            MouseLeftButtonUp="Image_Click" Tag="{Binding ImageUrl}">
                                                        <!-- Viewbox scales DOWN large images but keeps small ones at natural size -->
                                                        <Viewbox MaxWidth="200" MaxHeight="200" 
                                                                 Stretch="Uniform" 
                                                                 StretchDirection="DownOnly">
                                                            <Image Source="{Binding ImageUrl, Converter={StaticResource UrlToImageSourceConverter}}"
                                                                   RenderOptions.BitmapScalingMode="HighQuality"/>
                                                        </Viewbox>
                                                    </Border>
                                                    <TextBlock Text="{Binding Timestamp, StringFormat=HH:mm}"
                                                               HorizontalAlignment="Right"
                                                               FontSize="10"
                                                               Foreground="#888888"
                                                               Margin="8,4,8,4"/>
                                                </StackPanel>
                                            </Border>
                                        </Grid>
                                    </DataTemplate>
                                </converters:ChatMessageTemplateSelector.ImageMessageTemplate>
                                
                                <!-- Image Pending Template - Modern Design for Receiver -->
                                <converters:ChatMessageTemplateSelector.ImagePendingTemplate>
                                    <DataTemplate DataType="{x:Type models:ChatMessageItem}">
                                        <Grid Margin="{Binding IsMine, Converter={StaticResource IsMineToMarginConverter}}"
                                              HorizontalAlignment="{Binding IsMine, Converter={StaticResource IsMineToAlignmentConverter}}">
                                            <Border Background="{Binding IsMine, Converter={StaticResource IsMineToBubbleColorConverter}}"
                                                    BorderBrush="{Binding IsMine, Converter={StaticResource IsMineToBorderConverter}}"
                                                    BorderThickness="1"
                                                    CornerRadius="{Binding IsMine, Converter={StaticResource IsMineToCornerRadiusConverter}}"
                                                    Padding="8"
                                                    MinWidth="180" MaxWidth="220">
                                                <StackPanel>
                                                    <!-- Sender Name -->
                                                    <TextBlock Text="{Binding SenderName}"
                                                               FontSize="11"
                                                               FontWeight="SemiBold"
                                                               Foreground="{StaticResource PrimaryBrush}"
                                                               Margin="4,0,4,8"/>
                                                    
                                                    <!-- Blurred Image Preview Container -->
                                                    <Border CornerRadius="12" 
                                                            ClipToBounds="True" 
                                                            Background="#F0F0F0"
                                                            Height="140">
                                                        <Grid>
                                                            <!-- Blurred Background Image -->
                                                            <Image Source="{Binding ImageUrl, Converter={StaticResource UrlToImageSourceConverter}}"
                                                                   Stretch="UniformToFill"
                                                                   Opacity="0.3"
                                                                   RenderOptions.BitmapScalingMode="LowQuality">
                                                                <Image.Effect>
                                                                    <BlurEffect Radius="20"/>
                                                                </Image.Effect>
                                                            </Image>
                                                            
                                                            <!-- Dark Overlay -->
                                                            <Border Background="#60000000"/>
                                                            
                                                            <!-- Center Content -->
                                                            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                                                <!-- Image Icon -->
                                                                <Border Background="#80FFFFFF" 
                                                                        CornerRadius="25" 
                                                                        Width="50" Height="50"
                                                                        Margin="0,0,0,10">
                                                                    <Path Data="M21,3H3C2,3 1,4 1,5V19A2,2 0 0,0 3,21H21C22,21 23,20 23,19V5C23,4 22,3 21,3M5,17L8.5,12.5L11,15.5L14.5,11L19,17H5Z"
                                                                          Fill="{StaticResource PrimaryBrush}"
                                                                          Width="24" Height="24"
                                                                          Stretch="Uniform"
                                                                          HorizontalAlignment="Center"
                                                                          VerticalAlignment="Center"/>
                                                                </Border>
                                                                
                                                                <!-- File Name -->
                                                                <TextBlock Text="{Binding FileName}"
                                                                           Foreground="White"
                                                                           FontSize="11"
                                                                           FontWeight="Medium"
                                                                           TextTrimming="CharacterEllipsis"
                                                                           MaxWidth="160"
                                                                           HorizontalAlignment="Center"
                                                                           Margin="0,0,0,4"/>
                                                                
                                                                <!-- "Image" Label -->
                                                                <TextBlock Text="ðŸ“· Image"
                                                                           Foreground="#CCCCCC"
                                                                           FontSize="10"
                                                                           HorizontalAlignment="Center"/>
                                                            </StackPanel>
                                                        </Grid>
                                                    </Border>
                                                    
                                                    <!-- Action Buttons -->
                                                    <Grid Margin="0,12,0,4">
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="8"/>
                                                            <ColumnDefinition Width="*"/>
                                                        </Grid.ColumnDefinitions>
                                                        
                                                        <!-- Accept Button -->
                                                        <Button Grid.Column="0"
                                                                Content="âœ“ Accepter"
                                                                Tag="{Binding TransferId}"
                                                                Click="AcceptTransfer_Click"
                                                                Cursor="Hand">
                                                            <Button.Template>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border x:Name="border" 
                                                                            Background="{StaticResource AcceptBrush}" 
                                                                            CornerRadius="18" 
                                                                            Padding="12,8">
                                                                        <ContentPresenter HorizontalAlignment="Center" 
                                                                                          VerticalAlignment="Center"
                                                                                          TextBlock.Foreground="White"
                                                                                          TextBlock.FontWeight="SemiBold"
                                                                                          TextBlock.FontSize="12"/>
                                                                    </Border>
                                                                    <ControlTemplate.Triggers>
                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                            <Setter TargetName="border" Property="Background" Value="#45A049"/>
                                                                        </Trigger>
                                                                    </ControlTemplate.Triggers>
                                                                </ControlTemplate>
                                                            </Button.Template>
                                                        </Button>
                                                        
                                                        <!-- Decline Button -->
                                                        <Button Grid.Column="2"
                                                                Content="âœ— Refuser"
                                                                Tag="{Binding TransferId}"
                                                                Click="DeclineTransfer_Click"
                                                                Cursor="Hand">
                                                            <Button.Template>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border x:Name="border" 
                                                                            Background="White" 
                                                                            BorderBrush="{StaticResource DeclineBrush}"
                                                                            BorderThickness="1.5"
                                                                            CornerRadius="18" 
                                                                            Padding="12,8">
                                                                        <ContentPresenter HorizontalAlignment="Center" 
                                                                                          VerticalAlignment="Center"
                                                                                          TextBlock.Foreground="{StaticResource DeclineBrush}"
                                                                                          TextBlock.FontWeight="SemiBold"
                                                                                          TextBlock.FontSize="12"/>
                                                                    </Border>
                                                                    <ControlTemplate.Triggers>
                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                            <Setter TargetName="border" Property="Background" Value="#FFF5F5"/>
                                                                        </Trigger>
                                                                    </ControlTemplate.Triggers>
                                                                </ControlTemplate>
                                                            </Button.Template>
                                                        </Button>
                                                    </Grid>
                                                    
                                                    <!-- Timestamp -->
                                                    <TextBlock Text="{Binding Timestamp, StringFormat=HH:mm}"
                                                               HorizontalAlignment="Right"
                                                               FontSize="10"
                                                               Foreground="#888888"
                                                               Margin="4,4,4,0"/>
                                                </StackPanel>
                                            </Border>
                                        </Grid>
                                    </DataTemplate>
                                </converters:ChatMessageTemplateSelector.ImagePendingTemplate>
                                
                                <!-- Audio Pending Template - Modern Design for Audio Files Awaiting Acceptance -->
                                <converters:ChatMessageTemplateSelector.AudioPendingTemplate>
                                    <DataTemplate DataType="{x:Type models:ChatMessageItem}">
                                        <Grid Margin="{Binding IsMine, Converter={StaticResource IsMineToMarginConverter}}"
                                              HorizontalAlignment="{Binding IsMine, Converter={StaticResource IsMineToAlignmentConverter}}">
                                            <Border Background="{Binding IsMine, Converter={StaticResource IsMineToBubbleColorConverter}}"
                                                    BorderBrush="{Binding IsMine, Converter={StaticResource IsMineToBorderConverter}}"
                                                    BorderThickness="1"
                                                    CornerRadius="{Binding IsMine, Converter={StaticResource IsMineToCornerRadiusConverter}}"
                                                    Padding="10,8"
                                                    MinWidth="240" MaxWidth="300">
                                                <StackPanel>
                                                    <!-- Sender Name -->
                                                    <TextBlock Text="{Binding SenderName}"
                                                               FontSize="11"
                                                               FontWeight="SemiBold"
                                                               Foreground="{StaticResource PrimaryBrush}"
                                                               Margin="0,0,0,8"/>
                                                    
                                                    <!-- Audio File Preview -->
                                                    <Border Background="#F8F8F8" CornerRadius="12" Padding="12,10">
                                                        <Grid>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="Auto"/>
                                                                <ColumnDefinition Width="*"/>
                                                            </Grid.ColumnDefinitions>
                                                            
                                                            <!-- Music Icon -->
                                                            <Border Grid.Column="0" 
                                                                    Background="{StaticResource PrimaryBrush}" 
                                                                    CornerRadius="20" 
                                                                    Width="40" Height="40"
                                                                    Margin="0,0,12,0">
                                                                <Path Data="M12,3V12.26C11.5,12.09 11,12 10.5,12C8,12 6,14 6,16.5C6,19 8,21 10.5,21C13,21 15,19 15,16.5V6H19V3H12Z"
                                                                      Fill="White"
                                                                      Width="20" Height="20"
                                                                      Stretch="Uniform"
                                                                      HorizontalAlignment="Center"
                                                                      VerticalAlignment="Center"/>
                                                            </Border>
                                                            
                                                            <!-- File Info -->
                                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                                <TextBlock Text="{Binding FileName}"
                                                                           FontSize="13"
                                                                           FontWeight="Medium"
                                                                           Foreground="#333333"
                                                                           TextTrimming="CharacterEllipsis"
                                                                           MaxWidth="160"/>
                                                                <TextBlock Text="ðŸŽµ Fichier audio"
                                                                           FontSize="11"
                                                                           Foreground="#888888"
                                                                           Margin="0,2,0,0"/>
                                                            </StackPanel>
                                                        </Grid>
                                                    </Border>
                                                    
                                                    <!-- Action Buttons -->
                                                    <Grid Margin="0,12,0,4">
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="8"/>
                                                            <ColumnDefinition Width="*"/>
                                                        </Grid.ColumnDefinitions>
                                                        
                                                        <!-- Accept Button -->
                                                        <Button Grid.Column="0"
                                                                Content="âœ“ Accepter"
                                                                Tag="{Binding TransferId}"
                                                                Click="AcceptTransfer_Click"
                                                                Cursor="Hand">
                                                            <Button.Template>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border x:Name="border" 
                                                                            Background="{StaticResource AcceptBrush}" 
                                                                            CornerRadius="18" 
                                                                            Padding="12,8">
                                                                        <ContentPresenter HorizontalAlignment="Center" 
                                                                                          VerticalAlignment="Center"
                                                                                          TextBlock.Foreground="White"
                                                                                          TextBlock.FontWeight="SemiBold"
                                                                                          TextBlock.FontSize="12"/>
                                                                    </Border>
                                                                    <ControlTemplate.Triggers>
                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                            <Setter TargetName="border" Property="Background" Value="#45A049"/>
                                                                        </Trigger>
                                                                    </ControlTemplate.Triggers>
                                                                </ControlTemplate>
                                                            </Button.Template>
                                                        </Button>
                                                        
                                                        <!-- Decline Button -->
                                                        <Button Grid.Column="2"
                                                                Content="âœ— Refuser"
                                                                Tag="{Binding TransferId}"
                                                                Click="DeclineTransfer_Click"
                                                                Cursor="Hand">
                                                            <Button.Template>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border x:Name="border" 
                                                                            Background="White" 
                                                                            BorderBrush="{StaticResource DeclineBrush}"
                                                                            BorderThickness="1.5"
                                                                            CornerRadius="18" 
                                                                            Padding="12,8">
                                                                        <ContentPresenter HorizontalAlignment="Center" 
                                                                                          VerticalAlignment="Center"
                                                                                          TextBlock.Foreground="{StaticResource DeclineBrush}"
                                                                                          TextBlock.FontWeight="SemiBold"
                                                                                          TextBlock.FontSize="12"/>
                                                                    </Border>
                                                                    <ControlTemplate.Triggers>
                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                            <Setter TargetName="border" Property="Background" Value="#FFF5F5"/>
                                                                        </Trigger>
                                                                    </ControlTemplate.Triggers>
                                                                </ControlTemplate>
                                                            </Button.Template>
                                                        </Button>
                                                    </Grid>
                                                    
                                                    <!-- Timestamp -->
                                                    <TextBlock Text="{Binding Timestamp, StringFormat=HH:mm}"
                                                               HorizontalAlignment="Right"
                                                               FontSize="10"
                                                               Foreground="#888888"
                                                               Margin="0,4,0,0"/>
                                                </StackPanel>
                                            </Border>
                                        </Grid>
                                    </DataTemplate>
                                </converters:ChatMessageTemplateSelector.AudioPendingTemplate>
                                
                                <!-- Audio Message Template - Design Moderne -->
                                <converters:ChatMessageTemplateSelector.AudioMessageTemplate>
                                    <DataTemplate DataType="{x:Type models:ChatMessageItem}">
                                        <Grid Margin="{Binding IsMine, Converter={StaticResource IsMineToMarginConverter}}"
                                              HorizontalAlignment="{Binding IsMine, Converter={StaticResource IsMineToAlignmentConverter}}">
                                            <Border Background="{Binding IsMine, Converter={StaticResource IsMineToBubbleColorConverter}}"
                                                    BorderBrush="{Binding IsMine, Converter={StaticResource IsMineToBorderConverter}}"
                                                    BorderThickness="1"
                                                    CornerRadius="{Binding IsMine, Converter={StaticResource IsMineToCornerRadiusConverter}}"
                                                    Padding="10,8"
                                                    MinWidth="260"
                                                    MaxWidth="320">
                                                <StackPanel>
                                                    <!-- Sender Name (for received messages) -->
                                                    <TextBlock Text="{Binding SenderName}"
                                                               Visibility="{Binding IsMine, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=invert}"
                                                               FontSize="11"
                                                               FontWeight="SemiBold"
                                                               Foreground="{StaticResource PrimaryBrush}"
                                                               Margin="0,0,0,6"/>
                                                    
                                                    <!-- Voice Message Player -->
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="Auto"/>
                                                            <ColumnDefinition Width="*"/>
                                                        </Grid.ColumnDefinitions>
                                                        
                                                        <!-- Play/Pause Button with Circular Design -->
                                                        <Button x:Name="PlayButton"
                                                                Grid.Column="0" 
                                                                Width="48" Height="48"
                                                                Cursor="Hand"
                                                                Tag="{Binding FileUrl, Mode=OneWay}"
                                                                Click="AudioPlay_Click">
                                                            <Button.Template>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Grid>
                                                                        <!-- Outer Glow Effect -->
                                                                        <Ellipse Fill="{StaticResource PrimaryBrush}" 
                                                                                 Opacity="0.15"
                                                                                 Width="48" Height="48"/>
                                                                        <!-- Main Circle -->
                                                                        <Ellipse x:Name="MainCircle"
                                                                                 Fill="{StaticResource PrimaryBrush}" 
                                                                                 Width="42" Height="42"/>
                                                                        <!-- Play/Pause Icon - Changes based on IsPlaying -->
                                                                        <Path x:Name="PlayIcon"
                                                                              Data="{Binding IsPlaying, Converter={StaticResource AudioIconConverter}}"
                                                                              Fill="White"
                                                                              Width="16" Height="16"
                                                                              Stretch="Uniform"
                                                                              HorizontalAlignment="Center"
                                                                              VerticalAlignment="Center"
                                                                              Margin="2,0,0,0"/>
                                                                    </Grid>
                                                                    <ControlTemplate.Triggers>
                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                            <Setter TargetName="MainCircle" Property="Fill" Value="#C62828"/>
                                                                        </Trigger>
                                                                        <Trigger Property="IsPressed" Value="True">
                                                                            <Setter TargetName="MainCircle" Property="Fill" Value="#B71C1C"/>
                                                                        </Trigger>
                                                                    </ControlTemplate.Triggers>
                                                                </ControlTemplate>
                                                            </Button.Template>
                                                        </Button>
                                                        
                                                        <!-- Waveform and Info -->
                                                        <StackPanel Grid.Column="1" Margin="12,0,0,0" VerticalAlignment="Center">
                                                            <!-- Waveform Visual -->
                                                            <Grid Height="28" Margin="0,0,0,4">
                                                                <Canvas>
                                                                    <!-- Simulated Waveform Bars -->
                                                                    <Rectangle Canvas.Left="0" Canvas.Top="8" Width="3" Height="12" RadiusX="1.5" RadiusY="1.5" Fill="{StaticResource PrimaryBrush}" Opacity="0.6"/>
                                                                    <Rectangle Canvas.Left="6" Canvas.Top="4" Width="3" Height="20" RadiusX="1.5" RadiusY="1.5" Fill="{StaticResource PrimaryBrush}" Opacity="0.8"/>
                                                                    <Rectangle Canvas.Left="12" Canvas.Top="6" Width="3" Height="16" RadiusX="1.5" RadiusY="1.5" Fill="{StaticResource PrimaryBrush}" Opacity="0.5"/>
                                                                    <Rectangle Canvas.Left="18" Canvas.Top="2" Width="3" Height="24" RadiusX="1.5" RadiusY="1.5" Fill="{StaticResource PrimaryBrush}" Opacity="0.9"/>
                                                                    <Rectangle Canvas.Left="24" Canvas.Top="7" Width="3" Height="14" RadiusX="1.5" RadiusY="1.5" Fill="{StaticResource PrimaryBrush}" Opacity="0.4"/>
                                                                    <Rectangle Canvas.Left="30" Canvas.Top="3" Width="3" Height="22" RadiusX="1.5" RadiusY="1.5" Fill="{StaticResource PrimaryBrush}" Opacity="0.7"/>
                                                                    <Rectangle Canvas.Left="36" Canvas.Top="9" Width="3" Height="10" RadiusX="1.5" RadiusY="1.5" Fill="{StaticResource PrimaryBrush}" Opacity="0.5"/>
                                                                    <Rectangle Canvas.Left="42" Canvas.Top="5" Width="3" Height="18" RadiusX="1.5" RadiusY="1.5" Fill="{StaticResource PrimaryBrush}" Opacity="0.8"/>
                                                                    <Rectangle Canvas.Left="48" Canvas.Top="8" Width="3" Height="12" RadiusX="1.5" RadiusY="1.5" Fill="{StaticResource PrimaryBrush}" Opacity="0.6"/>
                                                                    <Rectangle Canvas.Left="54" Canvas.Top="4" Width="3" Height="20" RadiusX="1.5" RadiusY="1.5" Fill="{StaticResource PrimaryBrush}" Opacity="0.7"/>
                                                                    <Rectangle Canvas.Left="60" Canvas.Top="7" Width="3" Height="14" RadiusX="1.5" RadiusY="1.5" Fill="{StaticResource PrimaryBrush}" Opacity="0.5"/>
                                                                    <Rectangle Canvas.Left="66" Canvas.Top="10" Width="3" Height="8" RadiusX="1.5" RadiusY="1.5" Fill="{StaticResource PrimaryBrush}" Opacity="0.4"/>
                                                                    <Rectangle Canvas.Left="72" Canvas.Top="6" Width="3" Height="16" RadiusX="1.5" RadiusY="1.5" Fill="{StaticResource PrimaryBrush}" Opacity="0.6"/>
                                                                    <Rectangle Canvas.Left="78" Canvas.Top="8" Width="3" Height="12" RadiusX="1.5" RadiusY="1.5" Fill="{StaticResource PrimaryBrush}" Opacity="0.5"/>
                                                                    <Rectangle Canvas.Left="84" Canvas.Top="5" Width="3" Height="18" RadiusX="1.5" RadiusY="1.5" Fill="{StaticResource PrimaryBrush}" Opacity="0.7"/>
                                                                    <Rectangle Canvas.Left="90" Canvas.Top="9" Width="3" Height="10" RadiusX="1.5" RadiusY="1.5" Fill="{StaticResource PrimaryBrush}" Opacity="0.4"/>
                                                                    <Rectangle Canvas.Left="96" Canvas.Top="7" Width="3" Height="14" RadiusX="1.5" RadiusY="1.5" Fill="{StaticResource PrimaryBrush}" Opacity="0.5"/>
                                                                    <Rectangle Canvas.Left="102" Canvas.Top="10" Width="3" Height="8" RadiusX="1.5" RadiusY="1.5" Fill="{StaticResource PrimaryBrush}" Opacity="0.3"/>
                                                                    <Rectangle Canvas.Left="108" Canvas.Top="8" Width="3" Height="12" RadiusX="1.5" RadiusY="1.5" Fill="{StaticResource PrimaryBrush}" Opacity="0.4"/>
                                                                    <Rectangle Canvas.Left="114" Canvas.Top="11" Width="3" Height="6" RadiusX="1.5" RadiusY="1.5" Fill="{StaticResource PrimaryBrush}" Opacity="0.3"/>
                                                                </Canvas>
                                                            </Grid>
                                                            
                                                            <!-- Duration and Mic Icon -->
                                                            <StackPanel Orientation="Horizontal">
                                                                <TextBlock Text="{Binding AudioDurationString}"
                                                                           FontSize="12"
                                                                           FontWeight="Medium"
                                                                           Foreground="#555555"/>
                                                                <Path Data="M12,2C11.45,2 11,2.45 11,3V11.5C11,12.05 11.45,12.5 12,12.5C12.55,12.5 13,12.05 13,11.5V3C13,2.45 12.55,2 12,2M12,14A4,4 0 0,1 8,10H6A6,6 0 0,0 11,15.93V18H9V20H15V18H13V15.93C15.93,15.5 18,13.04 18,10H16A4,4 0 0,1 12,14Z"
                                                                      Fill="#888888"
                                                                      Width="12" Height="12"
                                                                      Stretch="Uniform"
                                                                      Margin="8,0,0,0"
                                                                      VerticalAlignment="Center"/>
                                                            </StackPanel>
                                                        </StackPanel>
                                                    </Grid>
                                                    
                                                    <!-- Timestamp -->
                                                    <TextBlock Text="{Binding Timestamp, StringFormat=HH:mm}"
                                                               HorizontalAlignment="Right"
                                                               FontSize="10"
                                                               Foreground="#888888"
                                                               Margin="0,6,0,0"/>
                                                </StackPanel>
                                            </Border>
                                        </Grid>
                                    </DataTemplate>
                                </converters:ChatMessageTemplateSelector.AudioMessageTemplate>
                                
                                <!-- Video Message Template -->
                                <converters:ChatMessageTemplateSelector.VideoMessageTemplate>
                                    <DataTemplate DataType="{x:Type models:ChatMessageItem}">
                                        <Grid Margin="{Binding IsMine, Converter={StaticResource IsMineToMarginConverter}}"
                                              HorizontalAlignment="{Binding IsMine, Converter={StaticResource IsMineToAlignmentConverter}}">
                                            <Border Background="{Binding IsMine, Converter={StaticResource IsMineToBubbleColorConverter}}"
                                                    BorderBrush="{Binding IsMine, Converter={StaticResource IsMineToBorderConverter}}"
                                                    BorderThickness="1"
                                                    CornerRadius="{Binding IsMine, Converter={StaticResource IsMineToCornerRadiusConverter}}"
                                                    Padding="8"
                                                    MinWidth="280"
                                                    MaxWidth="360">
                                                <StackPanel>
                                                    <!-- Sender Name -->
                                                    <TextBlock Text="{Binding SenderName}"
                                                               Visibility="{Binding IsMine, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=invert}"
                                                               FontSize="11"
                                                               FontWeight="SemiBold"
                                                               Foreground="{StaticResource PrimaryBrush}"
                                                               Margin="0,0,0,6"/>
                                                    
                                                    <!-- Video Player Area -->
                                                    <Border CornerRadius="8" 
                                                            ClipToBounds="True" 
                                                            Background="#1A1A2E"
                                                            MinHeight="180">
                                                        <Grid x:Name="VideoContainer" Tag="{Binding FileUrl}">
                                                            <!-- Embedded Video Player -->
                                                            <MediaElement x:Name="VideoPlayer"
                                                                          Source="{Binding FileUrl}"
                                                                          LoadedBehavior="Manual"
                                                                          UnloadedBehavior="Stop"
                                                                          Stretch="Uniform"
                                                                          Volume="1"
                                                                          MediaEnded="VideoPlayer_MediaEnded"/>
                                                            
                                                            <!-- Play/Pause Overlay Button -->
                                                            <Border x:Name="VideoOverlay"
                                                                    Background="#60000000"
                                                                    Cursor="Hand"
                                                                    MouseLeftButtonUp="VideoPlay_Click"
                                                                    MouseLeftButtonDown="VideoPlay_MouseDown"
                                                                    Tag="{Binding FileUrl}">
                                                                <Grid>
                                                                    <!-- Play Button Circle -->
                                                                    <Ellipse x:Name="PlayCircle"
                                                                             Width="60" Height="60" 
                                                                             Fill="#E03E2F" 
                                                                             Opacity="0.95"
                                                                             HorizontalAlignment="Center" 
                                                                             VerticalAlignment="Center">
                                                                        <Ellipse.Effect>
                                                                            <DropShadowEffect Color="Black" BlurRadius="12" Opacity="0.5" ShadowDepth="2"/>
                                                                        </Ellipse.Effect>
                                                                    </Ellipse>
                                                                    
                                                                    <!-- Play Icon -->
                                                                    <Path x:Name="PlayIcon"
                                                                          Data="M8,5.14V19.14L19,12.14L8,5.14Z" 
                                                                          Fill="White" 
                                                                          Width="24" Height="24"
                                                                          Stretch="Uniform"
                                                                          HorizontalAlignment="Center" 
                                                                          VerticalAlignment="Center"
                                                                          Margin="4,0,0,0"/>
                                                                    
                                                                    <!-- File Name at Bottom -->
                                                                    <Border Background="#90000000" 
                                                                            VerticalAlignment="Bottom"
                                                                            Padding="10,6">
                                                                        <Grid>
                                                                            <Grid.ColumnDefinitions>
                                                                                <ColumnDefinition Width="*"/>
                                                                                <ColumnDefinition Width="Auto"/>
                                                                            </Grid.ColumnDefinitions>
                                                                            <StackPanel Orientation="Horizontal" Grid.Column="0">
                                                                                <Path Data="M18,4V20H6V4H18M18,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V4A2,2 0 0,0 18,2Z"
                                                                                      Fill="White" 
                                                                                      Width="12" Height="12"
                                                                                      Stretch="Uniform"
                                                                                      VerticalAlignment="Center"
                                                                                      Opacity="0.8"
                                                                                      Margin="0,0,6,0"/>
                                                                                <TextBlock Text="{Binding FileName}" 
                                                                                           Foreground="White" 
                                                                                           FontSize="10"
                                                                                           TextTrimming="CharacterEllipsis"
                                                                                           MaxWidth="180"
                                                                                           VerticalAlignment="Center"/>
                                                                            </StackPanel>
                                                                            <TextBlock Grid.Column="1"
                                                                                       Text="Double-clic: ouvrir"
                                                                                       Foreground="#AAAAAA"
                                                                                       FontSize="9"
                                                                                       VerticalAlignment="Center"/>
                                                                        </Grid>
                                                                    </Border>
                                                                </Grid>
                                                            </Border>
                                                            
                                                            <!-- Transfer Status Overlay (for pending) -->
                                                            <Border Background="#E8000000" 
                                                                    Visibility="{Binding IsPending, Converter={StaticResource BoolToVisibilityConverter}}">
                                                                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                                                    <TextBlock Text="ðŸ“¹ VidÃ©o reÃ§ue" 
                                                                               Foreground="White" 
                                                                               FontSize="14"
                                                                               FontWeight="SemiBold"
                                                                               HorizontalAlignment="Center"
                                                                               Margin="0,0,0,4"/>
                                                                    <TextBlock Text="{Binding FileName}" 
                                                                               Foreground="#CCCCCC" 
                                                                               FontSize="11"
                                                                               HorizontalAlignment="Center"
                                                                               Margin="0,0,0,12"/>
                                                                    
                                                                    <!-- Accept/Decline buttons for receiver -->
                                                                    <StackPanel Orientation="Horizontal" 
                                                                                HorizontalAlignment="Center">
                                                                        <StackPanel.Visibility>
                                                                            <MultiBinding Converter="{StaticResource ShowActionsConverter}">
                                                                                <Binding Path="IsMine"/>
                                                                                <Binding Path="TransferStatus"/>
                                                                            </MultiBinding>
                                                                        </StackPanel.Visibility>
                                                                        <Button Content="âœ“ Accepter" 
                                                                                Background="#4CAF50" 
                                                                                Foreground="White"
                                                                                BorderThickness="0"
                                                                                Padding="16,8"
                                                                                Margin="0,0,10,0"
                                                                                Cursor="Hand"
                                                                                Tag="{Binding TransferId}"
                                                                                Click="AcceptTransfer_Click"/>
                                                                        <Button Content="âœ— Refuser" 
                                                                                Background="#F44336" 
                                                                                Foreground="White"
                                                                                BorderThickness="0"
                                                                                Padding="16,8"
                                                                                Cursor="Hand"
                                                                                Tag="{Binding TransferId}"
                                                                                Click="DeclineTransfer_Click"/>
                                                                    </StackPanel>
                                                                    
                                                                    <!-- Waiting message for sender -->
                                                                    <TextBlock Text="En attente d'acceptation..."
                                                                               Foreground="#AAAAAA"
                                                                               FontSize="11"
                                                                               FontStyle="Italic"
                                                                               HorizontalAlignment="Center"
                                                                               Visibility="{Binding IsMine, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                                                </StackPanel>
                                                            </Border>
                                                        </Grid>
                                                    </Border>
                                                    
                                                    <!-- Status and Timestamp -->
                                                    <Grid Margin="0,6,0,0">
                                                        <TextBlock Text="{Binding StatusText}"
                                                                   Visibility="{Binding StatusText, Converter={StaticResource BoolToVisibilityConverter}}"
                                                                   FontSize="10"
                                                                   FontStyle="Italic"
                                                                   Foreground="#888888"
                                                                   HorizontalAlignment="Left"/>
                                                        <TextBlock Text="{Binding Timestamp, StringFormat=HH:mm}"
                                                                   HorizontalAlignment="Right"
                                                                   FontSize="10"
                                                                   Foreground="#888888"/>
                                                    </Grid>
                                                </StackPanel>
                                            </Border>
                                        </Grid>
                                    </DataTemplate>
                                </converters:ChatMessageTemplateSelector.VideoMessageTemplate>
                                
                                <!-- Video Pending Template - Modern Design for Receiver -->
                                <converters:ChatMessageTemplateSelector.VideoPendingTemplate>
                                    <DataTemplate DataType="{x:Type models:ChatMessageItem}">
                                        <Grid Margin="{Binding IsMine, Converter={StaticResource IsMineToMarginConverter}}"
                                              HorizontalAlignment="{Binding IsMine, Converter={StaticResource IsMineToAlignmentConverter}}">
                                            <Border Background="{Binding IsMine, Converter={StaticResource IsMineToBubbleColorConverter}}"
                                                    BorderBrush="{Binding IsMine, Converter={StaticResource IsMineToBorderConverter}}"
                                                    BorderThickness="1"
                                                    CornerRadius="{Binding IsMine, Converter={StaticResource IsMineToCornerRadiusConverter}}"
                                                    Padding="8"
                                                    MinWidth="200" MaxWidth="260">
                                                <StackPanel>
                                                    <!-- Sender Name -->
                                                    <TextBlock Text="{Binding SenderName}"
                                                               FontSize="11"
                                                               FontWeight="SemiBold"
                                                               Foreground="{StaticResource PrimaryBrush}"
                                                               Margin="4,0,4,8"/>
                                                    
                                                    <!-- Video Preview Container -->
                                                    <Border CornerRadius="12" 
                                                            ClipToBounds="True" 
                                                            Background="#1A1A1A"
                                                            Height="120">
                                                        <Grid>
                                                            <!-- Dark gradient background -->
                                                            <Border>
                                                                <Border.Background>
                                                                    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                                                        <GradientStop Color="#2A2A2A" Offset="0"/>
                                                                        <GradientStop Color="#1A1A1A" Offset="1"/>
                                                                    </LinearGradientBrush>
                                                                </Border.Background>
                                                            </Border>
                                                            
                                                            <!-- Center Content -->
                                                            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                                                <!-- Video Play Icon -->
                                                                <Border Background="#80FFFFFF" 
                                                                        CornerRadius="30" 
                                                                        Width="60" Height="60"
                                                                        Margin="0,0,0,8">
                                                                    <Path Data="M8,5.14V19.14L19,12.14L8,5.14Z"
                                                                          Fill="{StaticResource PrimaryBrush}"
                                                                          Width="24" Height="24"
                                                                          Stretch="Uniform"
                                                                          HorizontalAlignment="Center"
                                                                          VerticalAlignment="Center"
                                                                          Margin="4,0,0,0"/>
                                                                </Border>
                                                                
                                                                <!-- File Name -->
                                                                <TextBlock Text="{Binding FileName}"
                                                                           Foreground="White"
                                                                           FontSize="11"
                                                                           FontWeight="Medium"
                                                                           TextTrimming="CharacterEllipsis"
                                                                           MaxWidth="180"
                                                                           HorizontalAlignment="Center"
                                                                           Margin="0,0,0,2"/>
                                                                
                                                                <!-- "Video" Label -->
                                                                <TextBlock Text="ðŸŽ¬ VidÃ©o"
                                                                           Foreground="#AAAAAA"
                                                                           FontSize="10"
                                                                           HorizontalAlignment="Center"/>
                                                            </StackPanel>
                                                        </Grid>
                                                    </Border>
                                                    
                                                    <!-- Action Buttons -->
                                                    <Grid Margin="0,12,0,4">
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="8"/>
                                                            <ColumnDefinition Width="*"/>
                                                        </Grid.ColumnDefinitions>
                                                        
                                                        <!-- Accept Button -->
                                                        <Button Grid.Column="0"
                                                                Content="âœ“ Accepter"
                                                                Tag="{Binding TransferId}"
                                                                Click="AcceptTransfer_Click"
                                                                Cursor="Hand">
                                                            <Button.Template>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border x:Name="border" 
                                                                            Background="{StaticResource AcceptBrush}" 
                                                                            CornerRadius="18" 
                                                                            Padding="12,8">
                                                                        <ContentPresenter HorizontalAlignment="Center" 
                                                                                          VerticalAlignment="Center"
                                                                                          TextBlock.Foreground="White"
                                                                                          TextBlock.FontWeight="SemiBold"
                                                                                          TextBlock.FontSize="12"/>
                                                                    </Border>
                                                                    <ControlTemplate.Triggers>
                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                            <Setter TargetName="border" Property="Background" Value="#45A049"/>
                                                                        </Trigger>
                                                                    </ControlTemplate.Triggers>
                                                                </ControlTemplate>
                                                            </Button.Template>
                                                        </Button>
                                                        
                                                        <!-- Decline Button -->
                                                        <Button Grid.Column="2"
                                                                Content="âœ— Refuser"
                                                                Tag="{Binding TransferId}"
                                                                Click="DeclineTransfer_Click"
                                                                Cursor="Hand">
                                                            <Button.Template>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border x:Name="border" 
                                                                            Background="White" 
                                                                            BorderBrush="{StaticResource DeclineBrush}"
                                                                            BorderThickness="1.5"
                                                                            CornerRadius="18" 
                                                                            Padding="12,8">
                                                                        <ContentPresenter HorizontalAlignment="Center" 
                                                                                          VerticalAlignment="Center"
                                                                                          TextBlock.Foreground="{StaticResource DeclineBrush}"
                                                                                          TextBlock.FontWeight="SemiBold"
                                                                                          TextBlock.FontSize="12"/>
                                                                    </Border>
                                                                    <ControlTemplate.Triggers>
                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                            <Setter TargetName="border" Property="Background" Value="#FFF5F5"/>
                                                                        </Trigger>
                                                                    </ControlTemplate.Triggers>
                                                                </ControlTemplate>
                                                            </Button.Template>
                                                        </Button>
                                                    </Grid>
                                                    
                                                    <!-- Timestamp -->
                                                    <TextBlock Text="{Binding Timestamp, StringFormat=HH:mm}"
                                                               HorizontalAlignment="Right"
                                                               FontSize="10"
                                                               Foreground="#888888"
                                                               Margin="4,4,4,0"/>
                                                </StackPanel>
                                            </Border>
                                        </Grid>
                                    </DataTemplate>
                                </converters:ChatMessageTemplateSelector.VideoPendingTemplate>
                                
                                <!-- File Transfer Template -->
                                <converters:ChatMessageTemplateSelector.FileTransferTemplate>
                                    <DataTemplate DataType="{x:Type models:ChatMessageItem}">
                                        <Grid Margin="{Binding IsMine, Converter={StaticResource IsMineToMarginConverter}}"
                                              HorizontalAlignment="{Binding IsMine, Converter={StaticResource IsMineToAlignmentConverter}}">
                                            <Border Background="{Binding IsMine, Converter={StaticResource IsMineToBubbleColorConverter}}"
                                                    BorderBrush="{Binding IsMine, Converter={StaticResource IsMineToBorderConverter}}"
                                                    BorderThickness="1"
                                                    CornerRadius="{Binding IsMine, Converter={StaticResource IsMineToCornerRadiusConverter}}"
                                                    Padding="12,10"
                                                    MinWidth="260">
                                                <StackPanel>
                                                    <TextBlock Text="{Binding SenderName}"
                                                               Visibility="{Binding IsMine, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=invert}"
                                                               FontSize="11"
                                                               FontWeight="SemiBold"
                                                               Foreground="{StaticResource PrimaryBrush}"
                                                               Margin="0,0,0,6"/>
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="Auto"/>
                                                            <ColumnDefinition Width="*"/>
                                                        </Grid.ColumnDefinitions>
                                                        <Border Grid.Column="0" 
                                                                Width="44" Height="44" 
                                                                Background="#F5F5F5" 
                                                                CornerRadius="8"
                                                                Margin="0,0,10,0">
                                                            <Path Data="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"
                                                                  Fill="#666666"
                                                                  Width="22" Height="22"
                                                                  Stretch="Uniform"
                                                                  HorizontalAlignment="Center"
                                                                  VerticalAlignment="Center"/>
                                                        </Border>
                                                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                            <TextBlock Text="{Binding FileName}"
                                                                       FontSize="13"
                                                                       FontWeight="Medium"
                                                                       Foreground="#333333"
                                                                       TextTrimming="CharacterEllipsis"
                                                                       MaxWidth="180"/>
                                                            <TextBlock Text="{Binding FileSize}"
                                                                       FontSize="11"
                                                                       Foreground="#888888"/>
                                                        </StackPanel>
                                                    </Grid>
                                                    <Grid Margin="0,8,0,0"
                                                          Visibility="{Binding TransferStatus, Converter={StaticResource TransferStatusToVisibilityConverter}, ConverterParameter=accepted}">
                                                        <Border Background="#E0E0E0" Height="4" CornerRadius="2"/>
                                                        <Border Background="{StaticResource PrimaryBrush}" 
                                                                Height="4" 
                                                                CornerRadius="2"
                                                                HorizontalAlignment="Left"
                                                                Width="{Binding TransferProgress, Converter={StaticResource ProgressToWidthConverter}, ConverterParameter=200}"/>
                                                    </Grid>
                                                    <StackPanel Orientation="Horizontal" 
                                                                HorizontalAlignment="Center"
                                                                Margin="0,10,0,0">
                                                        <StackPanel.Visibility>
                                                            <MultiBinding Converter="{StaticResource ShowActionsConverter}">
                                                                <Binding Path="IsMine"/>
                                                                <Binding Path="TransferStatus"/>
                                                            </MultiBinding>
                                                        </StackPanel.Visibility>
                                                        <Button Content="Accepter"
                                                                Padding="12,6"
                                                                FontSize="12"
                                                                FontWeight="SemiBold"
                                                                Background="{StaticResource AcceptBrush}"
                                                                Foreground="White"
                                                                BorderThickness="0"
                                                                Margin="0,0,8,0"
                                                                Cursor="Hand"
                                                                Tag="{Binding TransferId}"
                                                                Click="AcceptTransfer_Click">
                                                            <Button.Template>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border Background="{TemplateBinding Background}" CornerRadius="15" Padding="{TemplateBinding Padding}">
                                                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                                    </Border>
                                                                </ControlTemplate>
                                                            </Button.Template>
                                                        </Button>
                                                        <Button Content="Refuser"
                                                                Padding="12,6"
                                                                FontSize="12"
                                                                FontWeight="SemiBold"
                                                                Background="White"
                                                                Foreground="{StaticResource DeclineBrush}"
                                                                BorderThickness="1"
                                                                BorderBrush="{StaticResource DeclineBrush}"
                                                                Cursor="Hand"
                                                                Tag="{Binding TransferId}"
                                                                Click="DeclineTransfer_Click">
                                                            <Button.Template>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border Background="{TemplateBinding Background}" 
                                                                            BorderBrush="{TemplateBinding BorderBrush}"
                                                                            BorderThickness="{TemplateBinding BorderThickness}"
                                                                            CornerRadius="15" 
                                                                            Padding="{TemplateBinding Padding}">
                                                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                                    </Border>
                                                                </ControlTemplate>
                                                            </Button.Template>
                                                        </Button>
                                                    </StackPanel>
                                                    <TextBlock FontSize="11" 
                                                               FontStyle="Italic"
                                                               Foreground="#888888"
                                                               Margin="0,6,0,0"
                                                               HorizontalAlignment="Center"
                                                               Visibility="{Binding TransferStatus, Converter={StaticResource TransferStatusToVisibilityConverter}, ConverterParameter=notpending}">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding TransferStatus}" Value="Accepted">
                                                                        <Setter Property="Text" Value="Transfert acceptÃ©"/>
                                                                        <Setter Property="Foreground" Value="{StaticResource AcceptBrush}"/>
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding TransferStatus}" Value="Declined">
                                                                        <Setter Property="Text" Value="Transfert refusÃ©"/>
                                                                        <Setter Property="Foreground" Value="{StaticResource DeclineBrush}"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                    <TextBlock Text="{Binding Timestamp, StringFormat=HH:mm}"
                                                               HorizontalAlignment="Right"
                                                               FontSize="10"
                                                               Foreground="#888888"
                                                               Margin="0,4,0,0"/>
                                                </StackPanel>
                                            </Border>
                                        </Grid>
                                    </DataTemplate>
                                </converters:ChatMessageTemplateSelector.FileTransferTemplate>
                                
                                <!-- Status Message Template -->
                                <converters:ChatMessageTemplateSelector.StatusMessageTemplate>
                                    <DataTemplate DataType="{x:Type models:ChatMessageItem}">
                                        <Grid Margin="20,8">
                                            <Border Background="{Binding StatusClass, Converter={StaticResource StatusToBackgroundConverter}}" 
                                                    CornerRadius="12"
                                                    Padding="16,8"
                                                    HorizontalAlignment="Center">
                                                <TextBlock Text="{Binding Content}"
                                                           FontSize="12"
                                                           FontStyle="Italic"
                                                           Foreground="{Binding StatusClass, Converter={StaticResource StatusToForegroundConverter}}"
                                                           TextAlignment="Center"
                                                           TextWrapping="Wrap"/>
                                            </Border>
                                        </Grid>
                                    </DataTemplate>
                                </converters:ChatMessageTemplateSelector.StatusMessageTemplate>
                                
                                <!-- Buzz Message Template -->
                                <converters:ChatMessageTemplateSelector.BuzzMessageTemplate>
                                    <DataTemplate DataType="{x:Type models:ChatMessageItem}">
                                        <Grid Margin="20,12">
                                            <Border Background="#FFF3E0" 
                                                    BorderBrush="#FF9800"
                                                    BorderThickness="1"
                                                    CornerRadius="12"
                                                    Padding="16,10"
                                                    HorizontalAlignment="Center">
                                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                                    <Path Data="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6"
                                                          Fill="#FF9800"
                                                          Width="18" Height="18"
                                                          Stretch="Uniform"
                                                          Margin="0,0,8,0"/>
                                                    <TextBlock Text="{Binding Content}"
                                                               FontSize="13"
                                                               FontWeight="SemiBold"
                                                               Foreground="#E65100"/>
                                                </StackPanel>
                                            </Border>
                                        </Grid>
                                    </DataTemplate>
                                </converters:ChatMessageTemplateSelector.BuzzMessageTemplate>
                                
                                <!-- Block Message Template -->
                                <converters:ChatMessageTemplateSelector.BlockMessageTemplate>
                                    <DataTemplate DataType="{x:Type models:ChatMessageItem}">
                                        <Grid Margin="20,12">
                                            <Border Background="#FFEBEE" 
                                                    BorderBrush="#F44336"
                                                    BorderThickness="1"
                                                    CornerRadius="12"
                                                    Padding="16,10"
                                                    HorizontalAlignment="Center">
                                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                                    <Path Data="M12,2C17.5,2 22,6.5 22,12C22,17.5 17.5,22 12,22C6.5,22 2,17.5 2,12C2,6.5 6.5,2 12,2M12,4C7.58,4 4,7.58 4,12C4,16.42 7.58,20 12,20C16.42,20 20,16.42 20,12C20,7.58 16.42,4 12,4M16.5,7.5L7.5,16.5M7.5,7.5L16.5,16.5"
                                                          Fill="#F44336"
                                                          Width="18" Height="18"
                                                          Stretch="Uniform"
                                                          Margin="0,0,8,0"/>
                                                    <TextBlock Text="{Binding Content}"
                                                               FontSize="13"
                                                               FontWeight="SemiBold"
                                                               Foreground="#C62828"/>
                                                </StackPanel>
                                            </Border>
                                        </Grid>
                                    </DataTemplate>
                                </converters:ChatMessageTemplateSelector.BlockMessageTemplate>
                            </converters:ChatMessageTemplateSelector>
                        </ListBox.ItemTemplateSelector>
                    </ListBox>
                </Grid>
            </Border>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- INPUT AREA                                                       -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <Border Grid.Row="2" Background="White" Padding="20,12" CornerRadius="0,0,20,20">
                <Border.Effect>
                    <DropShadowEffect Color="#000000" BlurRadius="8" ShadowDepth="-2" Opacity="0.05" Direction="90"/>
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/> <!-- Typing Indicator -->
                        <RowDefinition Height="Auto"/> <!-- Toolbar -->
                        <RowDefinition Height="Auto"/> <!-- Input -->
                    </Grid.RowDefinitions>

                    <!-- Typing Indicator -->
                    <TextBlock x:Name="TypingIndicator" Grid.Row="0" Text="XXX est en train d'Ã©crire..." 
                               FontSize="11" Foreground="{StaticResource PrimaryColor}" FontStyle="Italic" 
                               Margin="55,0,0,5" Visibility="Collapsed"/>

                    <!-- Formatting Toolbar -->
                    <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="50,0,0,5">
                        <Button x:Name="BtnBold" Click="FormatBold_Click" Width="24" Height="24" Margin="0,0,5,0" Background="Transparent" BorderThickness="0" ToolTip="Gras">
                            <Path Data="M13.5,15.5H10V12.5H13.5A1.5,1.5 0 0,1 15,14A1.5,1.5 0 0,1 13.5,15.5M10,6.5H13A1.5,1.5 0 0,1 14.5,8A1.5,1.5 0 0,1 13,9.5H10M15.6,10.79C16.57,10.11 17.25,9 17.25,8C17.25,5.74 15.5,4 13.25,4H7V18H14.04C16.14,18 17.75,16.3 17.75,14.21C17.75,12.69 16.89,11.39 15.6,10.79Z" Fill="#666" Stretch="Uniform" Width="12" Height="12"/>
                        </Button>
                        <Button x:Name="BtnItalic" Click="FormatItalic_Click" Width="24" Height="24" Margin="0,0,5,0" Background="Transparent" BorderThickness="0" ToolTip="Italique">
                            <Path Data="M10,4V7H12.21L8.79,15H6V18H14V15H11.79L15.21,7H18V4H10Z" Fill="#666" Stretch="Uniform" Width="12" Height="12"/>
                        </Button>
                        <Button x:Name="BtnUnderline" Click="FormatUnderline_Click" Width="24" Height="24" Margin="0,0,10,0" Background="Transparent" BorderThickness="0" ToolTip="SoulignÃ©">
                            <Path Data="M5,21H19V19H5V21M12,17A6,6 0 0,0 18,11V3H15.5V11A3.5,3.5 0 0,1 12,14.5A3.5,3.5 0 0,1 8.5,11V3H6V11A6,6 0 0,0 12,17Z" Fill="#666" Stretch="Uniform" Width="12" Height="12"/>
                        </Button>
                        
                        <!-- Color Picker (Popup Top) -->
                        <ToggleButton x:Name="BtnColor" Width="24" Height="24" Margin="0,0,10,0" Background="Transparent" BorderThickness="0" ToolTip="Couleur du texte">
                            <Path Data="M17.5,12A1.5,1.5 0 0,1 16,10.5A1.5,1.5 0 0,1 17.5,9A1.5,1.5 0 0,1 19,10.5A1.5,1.5 0 0,1 17.5,12M14.5,8A1.5,1.5 0 0,1 13,6.5A1.5,1.5 0 0,1 14.5,5A1.5,1.5 0 0,1 16,6.5A1.5,1.5 0 0,1 14.5,8M9.5,8A1.5,1.5 0 0,1 8,6.5A1.5,1.5 0 0,1 9.5,5A1.5,1.5 0 0,1 11,6.5A1.5,1.5 0 0,1 9.5,8M6.5,12A1.5,1.5 0 0,1 5,10.5A1.5,1.5 0 0,1 6.5,9A1.5,1.5 0 0,1 8,10.5A1.5,1.5 0 0,1 6.5,12M12,3A9,9 0 0,0 3,12A9,9 0 0,0 12,21C12,21 13.71,21 14.31,20.4C14.7,20 15,19.56 15,19.08V19C15,18.45 15.45,18 16,18H17A5,5 0 0,0 22,13C22,7.46 17.54,3 12,3Z" 
                                  Fill="#666" Stretch="Uniform" Width="16" Height="16"/>
                        </ToggleButton>
                        
                        <!-- BUZZ Button -->
                        <Button x:Name="BtnBuzz" Click="Buzz_Click" Width="24" Height="24" Margin="0,0,10,0" Background="Transparent" BorderThickness="0" ToolTip="Envoyer un BUZZ" Visibility="Collapsed">
                            <Path Data="M12,2A2,2 0 0,1 14,4C14,4.74 13.6,5.39 13,5.73V7H14A7,7 0 0,1 21,14H22A1,1 0 0,1 23,15V18A1,1 0 0,1 22,19H2V18A1,1 0 0,1 3,17V15A1,1 0 0,1 4,14H5A7,7 0 0,1 12,7H13V5.73C12.4,5.39 12,4.74 12,4A2,2 0 0,1 12,2M7.5,20A4.5,4.5 0 0,0 12,24.5A4.5,4.5 0 0,0 16.5,20H7.5Z" 
                                  Fill="#2196F3" Stretch="Uniform" Width="16" Height="16"/>
                        </Button>

                        <Popup IsOpen="{Binding IsChecked, ElementName=BtnColor}" PlacementTarget="{Binding ElementName=BtnColor}" Placement="Top" StaysOpen="False">
                            <Border Background="White" BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="8" Padding="5">
                                <Border.Effect>
                                    <DropShadowEffect BlurRadius="10" ShadowDepth="2" Opacity="0.1"/>
                                </Border.Effect>
                                <WrapPanel Width="140">
                                    <!-- Modern Colors -->
                                    <Button Click="Color_Click" Tag="#000000" Width="20" Height="20" Margin="2" Background="Black" BorderThickness="0" Cursor="Hand" ToolTip="Noir"/>
                                    <Button Click="Color_Click" Tag="#FF5252" Width="20" Height="20" Margin="2" Background="#FF5252" BorderThickness="0" Cursor="Hand" ToolTip="Rouge Corail"/>
                                    <Button Click="Color_Click" Tag="#FF4081" Width="20" Height="20" Margin="2" Background="#FF4081" BorderThickness="0" Cursor="Hand" ToolTip="Rose"/>
                                    <Button Click="Color_Click" Tag="#E040FB" Width="20" Height="20" Margin="2" Background="#E040FB" BorderThickness="0" Cursor="Hand" ToolTip="Violet"/>
                                    <Button Click="Color_Click" Tag="#7C4DFF" Width="20" Height="20" Margin="2" Background="#7C4DFF" BorderThickness="0" Cursor="Hand" ToolTip="Indigo"/>
                                    <Button Click="Color_Click" Tag="#536DFE" Width="20" Height="20" Margin="2" Background="#536DFE" BorderThickness="0" Cursor="Hand" ToolTip="Bleu Royal"/>
                                    <Button Click="Color_Click" Tag="#448AFF" Width="20" Height="20" Margin="2" Background="#448AFF" BorderThickness="0" Cursor="Hand" ToolTip="Bleu"/>
                                    <Button Click="Color_Click" Tag="#40C4FF" Width="20" Height="20" Margin="2" Background="#40C4FF" BorderThickness="0" Cursor="Hand" ToolTip="Bleu Ciel"/>
                                    <Button Click="Color_Click" Tag="#18FFFF" Width="20" Height="20" Margin="2" Background="#18FFFF" BorderThickness="0" Cursor="Hand" ToolTip="Cyan"/>
                                    <Button Click="Color_Click" Tag="#69F0AE" Width="20" Height="20" Margin="2" Background="#69F0AE" BorderThickness="0" Cursor="Hand" ToolTip="Menthe"/>
                                    <Button Click="Color_Click" Tag="#B2FF59" Width="20" Height="20" Margin="2" Background="#B2FF59" BorderThickness="0" Cursor="Hand" ToolTip="Vert Lime"/>
                                    <Button Click="Color_Click" Tag="#FFD740" Width="20" Height="20" Margin="2" Background="#FFD740" BorderThickness="0" Cursor="Hand" ToolTip="Jaune"/>
                                    <Button Click="Color_Click" Tag="#FFAB40" Width="20" Height="20" Margin="2" Background="#FFAB40" BorderThickness="0" Cursor="Hand" ToolTip="Orange"/>
                                    <Button Click="Color_Click" Tag="#FF6E40" Width="20" Height="20" Margin="2" Background="#FF6E40" BorderThickness="0" Cursor="Hand" ToolTip="Orange FoncÃ©"/>
                                </WrapPanel>
                            </Border>
                        </Popup>
                    </StackPanel>

                    <!-- Input Controls -->
                    <Grid Grid.Row="2">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Attachment Button (Paperclip) -->
                        <Button x:Name="AttachmentButton" Grid.Column="0" Style="{StaticResource IconButtonStyle}" ToolTip="Joindre un fichier" Margin="0,0,10,0" Click="AttachmentButton_Click">
                            <Path Data="M16.5,6V17.5A4,4 0 0,1 12.5,21.5A4,4 0 0,1 8.5,17.5V5A2.5,2.5 0 0,1 11,2.5A2.5,2.5 0 0,1 13.5,5V15.5A1,1 0 0,1 12.5,16.5A1,1 0 0,1 11.5,15.5V6H10V15.5A2.5,2.5 0 0,0 12.5,18A2.5,2.5 0 0,0 15,15.5V5A4,4 0 0,0 11,1A4,4 0 0,0 7,5V17.5A5.5,5.5 0 0,0 12.5,23A5.5,5.5 0 0,0 18,17.5V6H16.5Z" 
                                  Fill="{StaticResource TextLightColor}" Stretch="Uniform" Width="16" Height="16"/>
                        </Button>

                        <!-- Text Input -->
                        <Border Grid.Column="1" Background="{StaticResource LightGrayColor}" CornerRadius="16" Height="48">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <RichTextBox x:Name="MessageInput" Grid.Column="0" 
                                             Background="Transparent" BorderThickness="0" 
                                             Padding="18,12,5,8"
                                             FontSize="14" Foreground="{StaticResource TextDarkColor}"
                                             PreviewKeyDown="MessageInput_KeyDown" TextChanged="MessageInput_TextChanged">
                                    <FlowDocument>
                                        <Paragraph Margin="0">
                                            <Run Text=""/>
                                        </Paragraph>
                                    </FlowDocument>
                                </RichTextBox>
                                
                                <!-- Audio Message Button -->
                                <Button x:Name="AudioButton" Grid.Column="1" Style="{StaticResource IconButtonStyle}" 
                                        Width="36" Height="36" Margin="0,0,4,0" ToolTip="Message Audio" Click="AudioButton_Click">
                                    <Path Data="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z" 
                                          Fill="{StaticResource PrimaryColor}" Stretch="Uniform" Width="16" Height="16"/>
                                </Button>

                                <!-- Emoji Button -->
                                <Button x:Name="EmojiButton" Grid.Column="2" Style="{StaticResource IconButtonStyle}" 
                                        Width="36" Height="36" Margin="0,0,6,0" ToolTip="Emojis" Click="EmojiButton_Click">
                                    <Path Data="M12,17.5C14.33,17.5 16.3,16.04 17.11,14H6.89C7.69,16.04 9.67,17.5 12,17.5M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M10,10H8V8H10V10M16,10H14V8H16V10Z" 
                                          Fill="#FFC107" Stretch="Uniform" Width="18" Height="18"/>
                                </Button>
                                
                                <Popup x:Name="SmileyPopup" PlacementTarget="{Binding ElementName=EmojiButton}" 
                                       Placement="Top" StaysOpen="False" AllowsTransparency="True">
                                    <Border Background="White" BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="16" Padding="12">
                                        <Border.Effect>
                                            <DropShadowEffect BlurRadius="20" ShadowDepth="4" Opacity="0.15"/>
                                        </Border.Effect>
                                        <ScrollViewer MaxHeight="220" Width="280" VerticalScrollBarVisibility="Auto">
                                            <WrapPanel x:Name="SmileyPanel" Width="260"/>
                                        </ScrollViewer>
                                    </Border>
                                </Popup>
                            </Grid>
                        </Border>

                        <!-- Send Button -->
                        <Button x:Name="SendButton" Grid.Column="2" Style="{StaticResource SendButtonStyle}" Margin="12,0,0,0" Click="Send_Click" ToolTip="Envoyer">
                             <Path Data="M2,21L23,12L2,3V10L17,12L2,14V21Z" Fill="White" Stretch="Uniform" Width="18" Height="18" Margin="2,0,0,0"/>
                        </Button>
                    </Grid>
                </Grid>
            </Border>
        </Grid>
    </Border>
</Window>
