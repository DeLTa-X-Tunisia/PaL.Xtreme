<Window x:Class="PaLX.Client.ChatWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:wv2="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
        xmlns:System="clr-namespace:System;assembly=mscorlib"
        mc:Ignorable="d"
        Title="Chat" Height="550" Width="700"
        WindowStyle="None" AllowsTransparency="True" Background="Transparent"
        ResizeMode="CanResizeWithGrip"
        WindowStartupLocation="CenterScreen">

    <Window.Resources>
        <!-- Colors -->
        <SolidColorBrush x:Key="PrimaryColor" Color="#0078D7"/>
        <SolidColorBrush x:Key="LightGrayColor" Color="#F3F3F3"/>
        <SolidColorBrush x:Key="BorderColor" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="TextDarkColor" Color="#333333"/>
        <SolidColorBrush x:Key="TextLightColor" Color="#888888"/>

        <!-- Styles -->
        <Style x:Key="IconButtonStyle" TargetType="Button">
            <Setter Property="FontFamily" Value="Segoe MDL2 Assets"/>
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="32"/>
            <Setter Property="Height" Value="32"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Foreground" Value="{StaticResource TextDarkColor}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="16">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#EAEAEA"/>
                </Trigger>
                <Trigger Property="IsPressed" Value="True">
                    <Setter Property="Background" Value="#DADADA"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="SendButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryColor}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="40"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="20">
                            <TextBlock Text="&#xE724;" FontFamily="Segoe MDL2 Assets" FontSize="18" 
                                       HorizontalAlignment="Center" VerticalAlignment="Center" Margin="2,0,0,0"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Opacity" Value="0.8"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <Style x:Key="AttachmentMenuItemStyle" TargetType="MenuItem">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="Foreground" Value="{StaticResource TextDarkColor}"/>
            <Setter Property="Icon">
                <Setter.Value>
                    <TextBlock FontFamily="Segoe MDL2 Assets" FontSize="16" VerticalAlignment="Center"/>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Border Background="White" CornerRadius="12" BorderBrush="{StaticResource BorderColor}" BorderThickness="1">
        <Border.Effect>
            <DropShadowEffect BlurRadius="20" ShadowDepth="5" Opacity="0.2" Color="Black"/>
        </Border.Effect>
        
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/> <!-- Header -->
                <RowDefinition Height="*"/>    <!-- Chat Body -->
                <RowDefinition Height="Auto"/> <!-- Input Area -->
            </Grid.RowDefinitions>

            <!-- Header -->
            <Border Grid.Row="0" Background="White" CornerRadius="12,12,0,0" Padding="15,10" MouseLeftButtonDown="Header_MouseDown">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="5" ShadowDepth="1" Opacity="0.05" Direction="270"/>
                </Border.Effect>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/> <!-- Avatar -->
                        <ColumnDefinition Width="*"/>    <!-- Info -->
                        <ColumnDefinition Width="Auto"/> <!-- Actions -->
                    </Grid.ColumnDefinitions>

                    <!-- Avatar -->
                    <Grid Grid.Column="0">
                        <Ellipse Width="42" Height="42" Stroke="{StaticResource BorderColor}" StrokeThickness="1">
                            <Ellipse.Fill>
                                <ImageBrush x:Name="AvatarBrush" ImageSource="/Assets/default_avatar.png" Stretch="UniformToFill"/>
                            </Ellipse.Fill>
                        </Ellipse>
                        <!-- Online Status Indicator -->
                        <Ellipse x:Name="StatusIndicator" Width="10" Height="10" Fill="#4CAF50" Stroke="White" StrokeThickness="1.5" 
                                 HorizontalAlignment="Right" VerticalAlignment="Bottom" Margin="0,0,2,2"/>
                    </Grid>

                    <!-- User Info -->
                    <StackPanel Grid.Column="1" Margin="12,0,0,0" VerticalAlignment="Center">
                        <TextBlock x:Name="PartnerName" Text="Utilisateur" FontWeight="SemiBold" FontSize="16" Foreground="{StaticResource TextDarkColor}"/>
                        <TextBlock x:Name="PartnerStatus" Text="En ligne" FontSize="12" Foreground="#4CAF50"/>
                    </StackPanel>

                    <!-- Actions -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                        <Button Style="{StaticResource IconButtonStyle}" Content="&#xE717;" ToolTip="Appel Audio" Margin="0,0,4,0"/>
                        <Button Style="{StaticResource IconButtonStyle}" Content="&#xE714;" ToolTip="Appel Vidéo" Margin="0,0,8,0"/>
                        
                        <!-- Clear History Button -->
                        <Button Click="ClearHistory_Click" Style="{StaticResource IconButtonStyle}" Content="&#xE74D;" ToolTip="Effacer l'historique" Margin="0,0,8,0"/>

                        <!-- Block Button (Red Dot) -->
                        <Button x:Name="BlockButton" Click="Block_Click" Style="{StaticResource IconButtonStyle}" ToolTip="Bloquer cet utilisateur" Margin="0,0,8,0">
                            <Border x:Name="BlockIndicator" Width="12" Height="12" CornerRadius="6" Background="#F44336" BorderBrush="White" BorderThickness="1">
                                <Border.Effect>
                                    <DropShadowEffect Color="Black" BlurRadius="2" ShadowDepth="1" Opacity="0.3"/>
                                </Border.Effect>
                            </Border>
                        </Button>

                        <Rectangle Width="1" Height="20" Fill="{StaticResource BorderColor}" Margin="0,0,8,0"/>

                        <Button Click="Minimize_Click" Style="{StaticResource IconButtonStyle}" Content="&#xE921;" Width="28" Height="28" FontSize="12"/>
                        <Button Click="Close_Click" Content="&#xE8BB;" Width="28" Height="28" FontSize="12" Foreground="#FF5252">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource IconButtonStyle}">
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#FFEBEE"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Chat Body -->
            <wv2:WebView2 x:Name="ChatWebView" Grid.Row="1" Margin="0"/>

            <!-- Input Area -->
            <Border Grid.Row="2" Background="White" Padding="15,10" CornerRadius="0,0,12,12">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/> <!-- Typing Indicator -->
                        <RowDefinition Height="Auto"/> <!-- Toolbar -->
                        <RowDefinition Height="Auto"/> <!-- Input -->
                    </Grid.RowDefinitions>

                    <!-- Typing Indicator -->
                    <TextBlock x:Name="TypingIndicator" Grid.Row="0" Text="XXX est en train d'écrire..." 
                               FontSize="11" Foreground="{StaticResource PrimaryColor}" FontStyle="Italic" 
                               Margin="55,0,0,5" Visibility="Collapsed"/>

                    <!-- Formatting Toolbar -->
                    <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="50,0,0,5">
                        <Button x:Name="BtnBold" Click="FormatBold_Click" Width="24" Height="24" Margin="0,0,5,0" Background="Transparent" BorderThickness="0" ToolTip="Gras">
                            <Path Data="M13.5,15.5H10V12.5H13.5A1.5,1.5 0 0,1 15,14A1.5,1.5 0 0,1 13.5,15.5M10,6.5H13A1.5,1.5 0 0,1 14.5,8A1.5,1.5 0 0,1 13,9.5H10M15.6,10.79C16.57,10.11 17.25,9 17.25,8C17.25,5.74 15.5,4 13.25,4H7V18H14.04C16.14,18 17.75,16.3 17.75,14.21C17.75,12.69 16.89,11.39 15.6,10.79Z" Fill="#666" Stretch="Uniform" Width="12" Height="12"/>
                        </Button>
                        <Button x:Name="BtnItalic" Click="FormatItalic_Click" Width="24" Height="24" Margin="0,0,5,0" Background="Transparent" BorderThickness="0" ToolTip="Italique">
                            <Path Data="M10,4V7H12.21L8.79,15H6V18H14V15H11.79L15.21,7H18V4H10Z" Fill="#666" Stretch="Uniform" Width="12" Height="12"/>
                        </Button>
                        <Button x:Name="BtnUnderline" Click="FormatUnderline_Click" Width="24" Height="24" Margin="0,0,10,0" Background="Transparent" BorderThickness="0" ToolTip="Souligné">
                            <Path Data="M5,21H19V19H5V21M12,17A6,6 0 0,0 18,11V3H15.5V11A3.5,3.5 0 0,1 12,14.5A3.5,3.5 0 0,1 8.5,11V3H6V11A6,6 0 0,0 12,17Z" Fill="#666" Stretch="Uniform" Width="12" Height="12"/>
                        </Button>
                        
                        <!-- Color Picker (Popup Top) -->
                        <ToggleButton x:Name="BtnColor" Width="24" Height="24" Margin="0,0,10,0" Background="Transparent" BorderThickness="0" ToolTip="Couleur du texte">
                            <Path Data="M17.5,12A1.5,1.5 0 0,1 16,10.5A1.5,1.5 0 0,1 17.5,9A1.5,1.5 0 0,1 19,10.5A1.5,1.5 0 0,1 17.5,12M14.5,8A1.5,1.5 0 0,1 13,6.5A1.5,1.5 0 0,1 14.5,5A1.5,1.5 0 0,1 16,6.5A1.5,1.5 0 0,1 14.5,8M9.5,8A1.5,1.5 0 0,1 8,6.5A1.5,1.5 0 0,1 9.5,5A1.5,1.5 0 0,1 11,6.5A1.5,1.5 0 0,1 9.5,8M6.5,12A1.5,1.5 0 0,1 5,10.5A1.5,1.5 0 0,1 6.5,9A1.5,1.5 0 0,1 8,10.5A1.5,1.5 0 0,1 6.5,12M12,3A9,9 0 0,0 3,12A9,9 0 0,0 12,21C12,21 13.71,21 14.31,20.4C14.7,20 15,19.56 15,19.08V19C15,18.45 15.45,18 16,18H17A5,5 0 0,0 22,13C22,7.46 17.54,3 12,3Z" 
                                  Fill="#666" Stretch="Uniform" Width="16" Height="16"/>
                        </ToggleButton>
                        
                        <!-- BUZZ Button -->
                        <Button x:Name="BtnBuzz" Click="Buzz_Click" Width="24" Height="24" Margin="0,0,10,0" Background="Transparent" BorderThickness="0" ToolTip="Envoyer un BUZZ" Visibility="Collapsed">
                            <Path Data="M12,2A2,2 0 0,1 14,4C14,4.74 13.6,5.39 13,5.73V7H14A7,7 0 0,1 21,14H22A1,1 0 0,1 23,15V18A1,1 0 0,1 22,19H2V18A1,1 0 0,1 3,17V15A1,1 0 0,1 4,14H5A7,7 0 0,1 12,7H13V5.73C12.4,5.39 12,4.74 12,4A2,2 0 0,1 12,2M7.5,20A4.5,4.5 0 0,0 12,24.5A4.5,4.5 0 0,0 16.5,20H7.5Z" 
                                  Fill="#2196F3" Stretch="Uniform" Width="16" Height="16"/>
                        </Button>

                        <Popup IsOpen="{Binding IsChecked, ElementName=BtnColor}" PlacementTarget="{Binding ElementName=BtnColor}" Placement="Top" StaysOpen="False">
                            <Border Background="White" BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="8" Padding="5">
                                <Border.Effect>
                                    <DropShadowEffect BlurRadius="10" ShadowDepth="2" Opacity="0.1"/>
                                </Border.Effect>
                                <WrapPanel Width="140">
                                    <!-- Modern Colors -->
                                    <Button Click="Color_Click" Tag="#000000" Width="20" Height="20" Margin="2" Background="Black" BorderThickness="0" Cursor="Hand" ToolTip="Noir"/>
                                    <Button Click="Color_Click" Tag="#FF5252" Width="20" Height="20" Margin="2" Background="#FF5252" BorderThickness="0" Cursor="Hand" ToolTip="Rouge Corail"/>
                                    <Button Click="Color_Click" Tag="#FF4081" Width="20" Height="20" Margin="2" Background="#FF4081" BorderThickness="0" Cursor="Hand" ToolTip="Rose"/>
                                    <Button Click="Color_Click" Tag="#E040FB" Width="20" Height="20" Margin="2" Background="#E040FB" BorderThickness="0" Cursor="Hand" ToolTip="Violet"/>
                                    <Button Click="Color_Click" Tag="#7C4DFF" Width="20" Height="20" Margin="2" Background="#7C4DFF" BorderThickness="0" Cursor="Hand" ToolTip="Indigo"/>
                                    <Button Click="Color_Click" Tag="#536DFE" Width="20" Height="20" Margin="2" Background="#536DFE" BorderThickness="0" Cursor="Hand" ToolTip="Bleu Royal"/>
                                    <Button Click="Color_Click" Tag="#448AFF" Width="20" Height="20" Margin="2" Background="#448AFF" BorderThickness="0" Cursor="Hand" ToolTip="Bleu"/>
                                    <Button Click="Color_Click" Tag="#40C4FF" Width="20" Height="20" Margin="2" Background="#40C4FF" BorderThickness="0" Cursor="Hand" ToolTip="Bleu Ciel"/>
                                    <Button Click="Color_Click" Tag="#18FFFF" Width="20" Height="20" Margin="2" Background="#18FFFF" BorderThickness="0" Cursor="Hand" ToolTip="Cyan"/>
                                    <Button Click="Color_Click" Tag="#69F0AE" Width="20" Height="20" Margin="2" Background="#69F0AE" BorderThickness="0" Cursor="Hand" ToolTip="Menthe"/>
                                    <Button Click="Color_Click" Tag="#B2FF59" Width="20" Height="20" Margin="2" Background="#B2FF59" BorderThickness="0" Cursor="Hand" ToolTip="Vert Lime"/>
                                    <Button Click="Color_Click" Tag="#FFD740" Width="20" Height="20" Margin="2" Background="#FFD740" BorderThickness="0" Cursor="Hand" ToolTip="Jaune"/>
                                    <Button Click="Color_Click" Tag="#FFAB40" Width="20" Height="20" Margin="2" Background="#FFAB40" BorderThickness="0" Cursor="Hand" ToolTip="Orange"/>
                                    <Button Click="Color_Click" Tag="#FF6E40" Width="20" Height="20" Margin="2" Background="#FF6E40" BorderThickness="0" Cursor="Hand" ToolTip="Orange Foncé"/>
                                </WrapPanel>
                            </Border>
                        </Popup>
                    </StackPanel>

                    <!-- Input Controls -->
                    <Grid Grid.Row="2">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Attachment Button (Paperclip) -->
                        <Button x:Name="AttachmentButton" Grid.Column="0" Style="{StaticResource IconButtonStyle}" ToolTip="Joindre un fichier" Margin="0,0,10,0" Click="AttachmentButton_Click">
                            <Path Data="M16.5,6V17.5A4,4 0 0,1 12.5,21.5A4,4 0 0,1 8.5,17.5V5A2.5,2.5 0 0,1 11,2.5A2.5,2.5 0 0,1 13.5,5V15.5A1,1 0 0,1 12.5,16.5A1,1 0 0,1 11.5,15.5V6H10V15.5A2.5,2.5 0 0,0 12.5,18A2.5,2.5 0 0,0 15,15.5V5A4,4 0 0,0 11,1A4,4 0 0,0 7,5V17.5A5.5,5.5 0 0,0 12.5,23A5.5,5.5 0 0,0 18,17.5V6H16.5Z" 
                                  Fill="{StaticResource TextLightColor}" Stretch="Uniform" Width="16" Height="16"/>
                        </Button>

                        <!-- Text Input -->
                        <Border Grid.Column="1" Background="{StaticResource LightGrayColor}" CornerRadius="20" Height="40">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <RichTextBox x:Name="MessageInput" Grid.Column="0" 
                                             Background="Transparent" BorderThickness="0" 
                                             Padding="15,8,5,8"
                                             FontSize="14" Foreground="{StaticResource TextDarkColor}"
                                             PreviewKeyDown="MessageInput_KeyDown" TextChanged="MessageInput_TextChanged">
                                    <FlowDocument>
                                        <Paragraph Margin="0">
                                            <Run Text=""/>
                                        </Paragraph>
                                    </FlowDocument>
                                </RichTextBox>
                                
                                <!-- Audio Message Button -->
                                <Button x:Name="AudioButton" Grid.Column="1" Style="{StaticResource IconButtonStyle}" 
                                        Width="30" Height="30" Margin="0,0,2,0" ToolTip="Message Audio" Click="AudioButton_Click">
                                    <Path Data="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z" 
                                          Fill="#FF4081" Stretch="Uniform" Width="14" Height="14"/>
                                </Button>

                                <!-- Emoji Button -->
                                <Button x:Name="EmojiButton" Grid.Column="2" Style="{StaticResource IconButtonStyle}" 
                                        Width="30" Height="30" Margin="0,0,5,0" ToolTip="Emojis" Click="EmojiButton_Click">
                                    <Path Data="M12,17.5C14.33,17.5 16.3,16.04 17.11,14H6.89C7.69,16.04 9.67,17.5 12,17.5M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M10,10H8V8H10V10M16,10H14V8H16V10Z" 
                                          Fill="#FFC107" Stretch="Uniform" Width="16" Height="16"/>
                                </Button>
                                
                                <Popup x:Name="SmileyPopup" PlacementTarget="{Binding ElementName=EmojiButton}" 
                                       Placement="Top" StaysOpen="False" AllowsTransparency="True">
                                    <Border Background="White" BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="8" Padding="10">
                                        <Border.Effect>
                                            <DropShadowEffect BlurRadius="10" ShadowDepth="2" Opacity="0.2"/>
                                        </Border.Effect>
                                        <ScrollViewer MaxHeight="200" Width="250" VerticalScrollBarVisibility="Auto">
                                            <WrapPanel x:Name="SmileyPanel" Width="230"/>
                                        </ScrollViewer>
                                    </Border>
                                </Popup>
                            </Grid>
                        </Border>

                        <!-- Send Button -->
                        <Button x:Name="SendButton" Grid.Column="2" Style="{StaticResource SendButtonStyle}" Margin="10,0,0,0" Click="Send_Click" ToolTip="Envoyer">
                             <Path Data="M2,21L23,12L2,3V10L17,12L2,14V21Z" Fill="White" Stretch="Uniform" Width="16" Height="16" Margin="2,0,0,0"/>
                        </Button>
                    </Grid>
                </Grid>
            </Border>
        </Grid>
    </Border>
</Window>
